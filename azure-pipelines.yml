trigger:
  branches:
    include:
      - master  # or your default branch

pool:
  vmImage: 'ubuntu-latest'

variables:
  system.debug: true
  imageName: 'vue-app'
  azureContainerRegistry: 'VuejsContainer'
  azureSubscription: 'VuejsDemoDocker'
  azureResourceGroup: 'VuejsDemoDocker_group'
  appName: 'VuejsDemoDocker'

jobs:
  - job: BuildAndPush
    displayName: 'Build and Push Docker Image to ACR'
    steps:
      - task: Checkout@1
        displayName: 'Checkout code'

      - task: Docker@2
        displayName: 'Build Docker Image'
        inputs:
          containerRegistry: $(azureContainerRegistry)
          repository: $(imageName)
          command: 'buildAndPush'
          Dockerfile: '**/Dockerfile'
          tags: $(tag)

  - job: DeployToAzure
    displayName: 'Deploy Docker Image to Azure App Service'
    dependsOn: BuildAndPush
    steps:
      - task: AzureCLI@2
        displayName: 'Azure CLI - Deploy Docker Image'
        inputs:
          azureSubscription: $(azureSubscription)
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            az webapp config container set \
              --name $(appName) \
              --resource-group $(azureResourceGroup) \
              --docker-custom-image-name $(azureContainerRegistry)/$(imageName):$(Build.BuildId)
